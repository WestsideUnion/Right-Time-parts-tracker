{"version":3,"sources":["../../../../../../../Documents/GitHub/Right-Time-parts-tracker/app/actions/status.ts","../../../../../../../Documents/GitHub/Right-Time-parts-tracker/app/actions/delete.ts","../../../../../../../Documents/GitHub/Right-Time-parts-tracker/.next-internal/server/app/receiving/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server';\n\nimport { createClient } from '@/lib/supabase/server';\nimport { BossStatus, StaffStatus } from '@/lib/types';\nimport { revalidatePath } from 'next/cache';\n\nasync function getUserRole(userId: string, supabase: Awaited<ReturnType<typeof createClient>>) {\n    const { data } = await supabase\n        .from('user_roles')\n        .select('role')\n        .eq('user_id', userId)\n        .single();\n    return data?.role;\n}\n\nasync function createAuditLog(\n    supabase: Awaited<ReturnType<typeof createClient>>,\n    itemId: string,\n    fieldChanged: 'boss_status' | 'staff_status',\n    oldValue: string | null,\n    newValue: string | null,\n    userId: string\n) {\n    await supabase.from('audit_logs').insert({\n        request_item_id: itemId,\n        field_changed: fieldChanged,\n        old_value: oldValue,\n        new_value: newValue || 'pending',\n        changed_by: userId,\n    });\n}\n\nexport async function updateBossStatus(itemId: string, newStatus: BossStatus) {\n    const supabase = await createClient();\n\n    const {\n        data: { user },\n        error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error('Not authenticated');\n    }\n\n    // Verify user is boss\n    const role = await getUserRole(user.id, supabase);\n    if (role !== 'boss') {\n        throw new Error('Only boss can update boss status');\n    }\n\n    // Get current item for audit log\n    const { data: currentItem } = await supabase\n        .from('request_items')\n        .select('boss_status')\n        .eq('id', itemId)\n        .single();\n\n    // Update status\n    const { error: updateError } = await supabase\n        .from('request_items')\n        .update({ boss_status: newStatus })\n        .eq('id', itemId);\n\n    if (updateError) {\n        console.error('Error updating boss status:', updateError);\n        throw new Error('Failed to update status');\n    }\n\n    // Create audit log\n    await createAuditLog(\n        supabase,\n        itemId,\n        'boss_status',\n        currentItem?.boss_status,\n        newStatus,\n        user.id\n    );\n\n    revalidatePath('/pick-list');\n    revalidatePath('/receiving');\n\n    return { success: true };\n}\n\nexport async function updateStaffStatus(itemId: string, newStatus: StaffStatus) {\n    const supabase = await createClient();\n\n    const {\n        data: { user },\n        error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error('Not authenticated');\n    }\n\n    // Check for admin override\n    const adminOverride = process.env.ADMIN_CAN_MODIFY_STAFF_STATUS === 'true';\n    const role = await getUserRole(user.id, supabase);\n\n    // Verify user is staff (or has admin override)\n    if (role !== 'staff' && !(role === 'boss' && adminOverride)) {\n        throw new Error('Only staff can update staff status');\n    }\n\n    // Get current item\n    const { data: currentItem } = await supabase\n        .from('request_items')\n        .select('boss_status, staff_status')\n        .eq('id', itemId)\n        .single();\n\n    // Check if item is discontinued (staff cannot update)\n    if (currentItem?.boss_status === 'discontinued' && role === 'staff') {\n        throw new Error('Cannot update discontinued items');\n    }\n\n    // Update status and installed_at\n    const updateData: { staff_status: StaffStatus; installed_at?: string | null } = {\n        staff_status: newStatus,\n    };\n\n    if (newStatus === 'installed') {\n        updateData.installed_at = new Date().toISOString();\n    } else {\n        updateData.installed_at = null; // Reset if changing away from installed\n    }\n\n    const { error: updateError } = await supabase\n        .from('request_items')\n        .update(updateData)\n        .eq('id', itemId);\n\n    if (updateError) {\n        console.error('Error updating staff status:', updateError);\n        throw new Error('Failed to update status');\n    }\n\n    // Create audit log\n    await createAuditLog(\n        supabase,\n        itemId,\n        'staff_status',\n        currentItem?.staff_status,\n        newStatus,\n        user.id\n    );\n\n    revalidatePath('/pick-list');\n    revalidatePath('/receiving');\n\n    return { success: true };\n}\n\nexport async function bulkUpdateBossStatus(itemIds: string[], newStatus: BossStatus) {\n    const supabase = await createClient();\n\n    const {\n        data: { user },\n        error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error('Not authenticated');\n    }\n\n    // Verify user is boss\n    const role = await getUserRole(user.id, supabase);\n    if (role !== 'boss') {\n        throw new Error('Only boss can update boss status');\n    }\n\n    // Get current items for audit logs\n    const { data: currentItems } = await supabase\n        .from('request_items')\n        .select('id, boss_status')\n        .in('id', itemIds);\n\n    // Update all items\n    const { error: updateError } = await supabase\n        .from('request_items')\n        .update({ boss_status: newStatus })\n        .in('id', itemIds);\n\n    if (updateError) {\n        console.error('Error bulk updating boss status:', updateError);\n        throw new Error('Failed to update statuses');\n    }\n\n    // Create audit logs for each item\n    if (currentItems) {\n        for (const item of currentItems) {\n            await createAuditLog(\n                supabase,\n                item.id,\n                'boss_status',\n                item.boss_status,\n                newStatus,\n                user.id\n            );\n        }\n    }\n\n    revalidatePath('/pick-list');\n    revalidatePath('/receiving');\n\n    return { success: true };\n}\n","'use server';\n\nimport { createClient } from '@/lib/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\nasync function getUserRole(userId: string, supabase: Awaited<ReturnType<typeof createClient>>) {\n    const { data } = await supabase\n        .from('user_roles')\n        .select('role')\n        .eq('user_id', userId)\n        .single();\n    return data?.role;\n}\n\nexport async function deleteItem(itemId: string) {\n    const supabase = await createClient();\n\n    const {\n        data: { user },\n        error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error('Not authenticated');\n    }\n\n    // Verify user is system_admin\n    const role = await getUserRole(user.id, supabase);\n    if (role !== 'system_admin') {\n        throw new Error('Only system admin can delete items');\n    }\n\n    // Delete the item\n    const { error: deleteError } = await supabase\n        .from('request_items')\n        .delete()\n        .eq('id', itemId);\n\n    if (deleteError) {\n        console.error('Error deleting item:', deleteError);\n        throw new Error('Failed to delete item');\n    }\n\n    revalidatePath('/pick-list');\n    revalidatePath('/receiving');\n\n    return { success: true };\n}\n\nexport async function bulkDeleteItems(itemIds: string[]) {\n    const supabase = await createClient();\n\n    const {\n        data: { user },\n        error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error('Not authenticated');\n    }\n\n    // Verify user is system_admin\n    const role = await getUserRole(user.id, supabase);\n    if (role !== 'system_admin') {\n        throw new Error('Only system admin can delete items');\n    }\n\n    // Delete all items\n    const { error: deleteError } = await supabase\n        .from('request_items')\n        .delete()\n        .in('id', itemIds);\n\n    if (deleteError) {\n        console.error('Error bulk deleting items:', deleteError);\n        throw new Error('Failed to delete items');\n    }\n\n    revalidatePath('/pick-list');\n    revalidatePath('/receiving');\n\n    return { success: true };\n}\n","export {updateStaffStatus as '603bc9c1796a7171c7c35f5d7b98d44b8252b48f8f'} from 'ACTIONS_MODULE0'\nexport {deleteItem as '40605760b4b2861f02c3e9b7270eb1eb8b0c7420b3'} from 'ACTIONS_MODULE1'\nexport {bulkDeleteItems as '40de1e46b98bfcdbc8e66fa18ffa3a74f84d1d9fb4'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"8DAEA,EAAA,EAAA,CAAA,CAAA,OAEA,EAAA,EAAA,CAAA,CAAA,mBAEA,eAAe,EAAY,CAAc,CAAE,CAAkD,EACzF,GAAM,MAAE,CAAI,CAAE,CAAG,MAAM,EAClB,IAAI,CAAC,cACL,MAAM,CAAC,QACP,EAAE,CAAC,UAAW,GACd,MAAM,GACX,OAAO,GAAM,IACjB,CAEA,eAAe,EACX,CAAkD,CAClD,CAAc,CACd,CAA4C,CAC5C,CAAuB,CACvB,CAAuB,CACvB,CAAc,EAEd,MAAM,EAAS,IAAI,CAAC,cAAc,MAAM,CAAC,CACrC,gBAAiB,EACjB,cAAe,EACf,UAAW,EACX,UAAW,GAAY,UACvB,WAAY,CAChB,EACJ,CAEO,eAAe,EAAiB,CAAc,CAAE,CAAqB,EACxE,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IAEjB,CACF,KAAM,MAAE,CAAI,CAAE,CACd,MAAO,CAAS,CACnB,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,GAAa,CAAC,EACd,IADoB,EACd,AAAI,MAAM,qBAKpB,GAAI,AAAS,QAAQ,CADR,MAAM,EAAY,EAAK,EAAE,CAAE,GAEpC,MAAU,AAAJ,MAAU,oCAIpB,GAAM,CAAE,KAAM,CAAW,CAAE,CAAG,MAAM,EAC/B,IAAI,CAAC,iBACL,MAAM,CAAC,eACP,EAAE,CAAC,KAAM,GACT,MAAM,GAGL,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,iBACL,MAAM,CAAC,CAAE,YAAa,CAAU,GAChC,EAAE,CAAC,KAAM,GAEd,GAAI,EAEA,MADA,KADa,GACL,KAAK,CAAC,8BAA+B,GACvC,AAAI,MAAM,2BAgBpB,OAZA,MAAM,EACF,EACA,EACA,cACA,GAAa,YACb,EACA,EAAK,EAAE,EAGX,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cAER,CAAE,SAAS,CAAK,CAC3B,CAEO,eAAe,EAAkB,CAAc,CAAE,CAAsB,EAC1E,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CACF,KAAM,MAAE,CAAI,CAAE,CACd,MAAO,CAAS,CACnB,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,GAAa,CAAC,EACd,IADoB,EACd,AAAI,MAAM,qBAIpB,IAAM,EAAgB,AAA8C,iBAAtC,GAAG,CAAC,6BAA6B,CACzD,EAAO,MAAM,EAAY,EAAK,EAAE,CAAE,GAGxC,GAAa,UAAT,GAAoB,CAAC,CAAU,SAAT,GAAmB,CAAA,CAAa,CACtD,EADyD,IACnD,AAAI,MAAM,sCAIpB,GAAM,CAAE,KAAM,CAAW,CAAE,CAAG,MAAM,EAC/B,IAAI,CAAC,iBACL,MAAM,CAAC,6BACP,EAAE,CAAC,KAAM,GACT,MAAM,GAGX,GAAI,GAAa,cAAgB,gBAA2B,SAAS,CAAlB,EAC/C,MAAM,AAAI,MAAM,oCAIpB,IAAM,EAA0E,CAC5E,aAAc,CAClB,EAEkB,aAAa,CAA3B,EACA,EAAW,YAAY,CAAG,IAAI,OAAO,WAAW,GAEhD,EAAW,YAAY,CAAG,KAG9B,CAHoC,EAG9B,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,eAJkE,EAKvE,MAAM,CAAC,GACP,EAAE,CAAC,KAAM,GAEd,GAAI,EAEA,MADA,KADa,GACL,KAAK,CAAC,+BAAgC,GACxC,AAAI,MAAM,2BAgBpB,OAZA,MAAM,EACF,EACA,EACA,eACA,GAAa,aACb,EACA,EAAK,EAAE,EAGX,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cAER,CAAE,SAAS,CAAK,CAC3B,CAEO,eAAe,EAAqB,CAAiB,CAAE,CAAqB,EAC/E,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CACF,KAAM,CAAE,MAAI,CAAE,CACd,MAAO,CAAS,CACnB,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,GAAa,CAAC,EACd,IADoB,EACV,AAAJ,MAAU,qBAKpB,GAAI,AAAS,QAAQ,CADR,MAAM,EAAY,EAAK,EAAE,CAAE,GAEpC,MAAM,AAAI,MAAM,oCAIpB,GAAM,CAAE,KAAM,CAAY,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,iBACL,MAAM,CAAC,mBACP,EAAE,CAAC,KAAM,GAGR,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,iBACL,MAAM,CAAC,CAAE,YAAa,CAAU,GAChC,EAAE,CAAC,KAAM,GAEd,GAAI,EAEA,MADA,KADa,GACL,KAAK,CAAC,mCAAoC,GAC5C,AAAI,MAAM,6BAIpB,GAAI,EACA,IAAK,IAAM,IADG,CACK,EACf,MAAM,EACF,EACA,CAHyB,CAGpB,EAAE,CACP,cACA,EAAK,WAAW,CAChB,EACA,EAAK,EAAE,EAQnB,MAHA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cAER,CAAE,SAAS,CAAK,CAC3B,CC1MA,eAAe,EAAY,CAAc,CAAE,CAAkD,EACzF,GAAM,MAAE,CAAI,CAAE,CAAG,MAAM,EAClB,IAAI,CAAC,cACL,MAAM,CAAC,QACP,EAAE,CAAC,UAAW,GACd,MAAM,GACX,OAAO,GAAM,IACjB,CAEO,eAAe,EAAW,CAAc,EAC3C,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CACF,KAAM,CAAE,MAAI,CAAE,CACd,MAAO,CAAS,CACnB,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,GAAa,CAAC,EACd,IADoB,EACV,AAAJ,MAAU,qBAKpB,GAAI,AAAS,gBAAgB,CADhB,MAAM,EAAY,EAAK,EAAE,CAAE,GAEpC,MAAM,AAAI,MAAM,sCAIpB,GAAM,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,iBACL,MAAM,GACN,EAAE,CAAC,KAAM,GAEd,GAAI,EAEA,MADA,KADa,GACL,KAAK,CAAC,uBAAwB,GAChC,AAAI,MAAM,yBAMpB,MAHA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cAER,CAAE,SAAS,CAAK,CAC3B,CAEO,eAAe,EAAgB,CAAiB,EACnD,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAE7B,CACF,KAAM,MAAE,CAAI,CAAE,CACd,MAAO,CAAS,CACnB,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,GAAa,CAAC,EACd,IADoB,EACd,AAAI,MAAM,qBAKpB,GAAI,AAAS,gBAAgB,CADhB,MAAM,EAAY,EAAK,EAAE,CAAE,GAEpC,MAAM,AAAI,MAAM,sCAIpB,GAAM,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,iBACL,MAAM,GACN,EAAE,CAAC,KAAM,GAEd,GAAI,EAEA,MADA,KADa,GACL,KAAK,CAAC,6BAA8B,GACtC,AAAI,MAAM,0BAMpB,MAHA,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,cACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cAER,CAAE,SAAS,CAAK,CAC3B,iCDlDsB,EAoDA,EAsEA,IA1HA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAoDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsEA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,mIC5IA,EAmCA,IAnCA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAmCA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,sFCjDtB,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA"}